
<!--
맨 처음 시작 화면. 완료
inner가 계속 변경될 예정.
누르면 소리 나오도록 조작하기.
다음 단계 : inner_start.html
-->
<div class="masonry-grid row row-cols-sm-2 row-cols-1 g-4">
  <div class="mobile-frame">
    <div class="inner-content" id="inner-content">
      
      <!--changable-->
      <a href="#" id="inner_main" onclick="get_inner_page(next='start')" class="d-flex flex-column justify-content-center bg-info h-100" >
        <div class="d-flex flex-column justify-content-center align-items-center" style="height: 90%;">
          <div class="text-white mb-2">나누는 사랑, 커지는 희망</div>
          <div class="mb-2"><h1 class="text-white">전자바우처<h1></div>
          <div class=""><h6 class="text-white">화면을 터치하세요</h6></div>
        </div>
        <div class="d-flex align-items-center bg-secondary" 
        style="height: 10%;justify-content: space-around">
  
          <img src="static/david/img/h_logo_1.png" style="width: 30%;" alt="image">
          <img src="static/david/img/logo_wh.svg" style="width: 30%;" alt="image">
        </div>
      </a>
      <!--changable-->

    </div>
  </div>
</div> 

<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function () {
   
  });

  function get_inner_page(next){
      console.log("====get_inner_page===")
      fetch('get_page/get_next_page?next='+next)
        .then(response => response.text())  
        .then(html => {
          document.getElementById('inner-content').innerHTML = html;
          //1초 후 시작
          // TODO: next에 따라서 start_recoding을 하고 안하고 결정하기.
          if(next == 'start'){
            //서비스 시작
            debugger
            start_recording();
          }else if(next == 'recognition')
          {
            //서비스 관리
            debugger
            camera_stream();
          }
          
        })
        .catch(error => console.error('Error loading the page: ', error));
  }

  function get_prev_page(prev){
      console.log("====get_prev_page===")
      fetch('get_page/get_prev_page?prev='+prev)
        .then(response => response.text())  
        .then(html => {
          document.getElementById('inner-content').innerHTML = html;
          //start_recording();
          stopCamera();
        })
        .catch(error => console.error('Error loading the page: ', error));
  }

  function start_recording(){
    /*
    실시간 음성 인식
    */
    console.log("====파이썬 서버 시작=====")
    fetch('/start_recording')
        .then(response => response.json())
        .then(data => {
            alert('페이지:: ' + data.return_result + '\n사용자 음성:: ' + data.audio_text);

            // llm 통과 후 다음 페이지 넘어갈 예정
            // 서버에서 처리 후 1,2,3 에 따라 페이지 넘길 예정 
            if(data.return_result !== 0){
              get_inner_page(data.return_result);
            }
           
            stopCamera();
        })
        .catch(error => console.error('Error:', error));
  }

  function camera_stream(){
    let video = document.getElementById('video');
    // 웹 카메라 시작
    if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                video.srcObject = stream;
                camera_recognition();
            })
            .catch(function(error) {
                console.error("===카메라 접근에 실패했습니다:", error);
            });
    } else {
        alert('===getUserMedia를 지원하지 않는 브라우저입니다.');
    }
  }

  function camera_recognition(){
    console.log("====camera_recognition=====")
    fetch('/start_recording')
        .then(response => response.json())
        .then(data => {
            alert('결과:: ' + data.return_result);

            stopCamera()
        })
        .catch(error => console.error('Error:', error));
  }

  // 카메라 종료
  function stopCamera() {
     
    document.getElementById('video').srcObject.getTracks().forEach(function(track) {
          track.stop();
      });
   
  }

</script>